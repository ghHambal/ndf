<!doctype html>
<html lang="th" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏ú‡∏±‡∏Å</title>
  <meta name="theme-color" content="#0ea75a"/>
<style>
  :root{
    --bg:#0b1220;
    --card:#0f1a30;
    --muted:#9fb0d0;
    --text:#eaf0ff;
    --line:rgba(255,255,255,.08);

    --g1:#0ea75a; /* ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ */
    --g2:#2563eb; /* ‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å */
    --g3:#f59e0b; /* ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å */
    --g4:#a855f7; /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ */

    --danger:#ef4444;
    --ok:#22c55e;
    --warn:#f59e0b;

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ó‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‚Äú‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‚Äù (‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î) */
    --on-warn:#ffe9bf;
    --on-ok:#c9f7d8;
    --on-danger:#ffd0d0;
    --on-info:#cfe3ff;

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏≠‡πà‡∏≠‡∏ô (‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î) */
    --bg-warn: rgba(245,158,11,.08);
    --bg-ok: rgba(34,197,94,.08);
    --bg-danger: rgba(239,68,68,.08);
    --bg-info: rgba(37,99,235,.08);
  }

  /* =========================
     THEME: LIGHT/DARK/SYSTEM
     ‡πÉ‡∏ä‡πâ data-theme ‡∏ö‡∏ô <html>
  ========================= */
  html[data-theme="light"]{
    --bg:#f5f7ff;
    --card: rgba(255,255,255,.92);
    --muted:#475569;           /* ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
    --text:#0b1220;
    --line:rgba(2,6,23,.10);

    --danger:#dc2626;
    --ok:#16a34a;
    --warn:#d97706;

    /* ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‚Äú‡∏ö‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‚Äù ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°) */
    --on-warn:#5a3b00;
    --on-ok:#053b1d;
    --on-danger:#5b0a0a;
    --on-info:#0b2a66;

    /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á */
    --bg-warn: rgba(217,119,6,.14);
    --bg-ok: rgba(22,163,74,.12);
    --bg-danger: rgba(220,38,38,.12);
    --bg-info: rgba(37,99,235,.12);
  }

  html[data-theme="light"] body{
    background:
      radial-gradient(1200px 600px at 40% -20%, rgba(14,167,90,.18), transparent 60%),
      radial-gradient(1200px 600px at 110% 10%, rgba(37,99,235,.18), transparent 55%),
      radial-gradient(900px 600px at -10% 100%, rgba(168,85,247,.16), transparent 55%),
      var(--bg);
  }

  html[data-theme="light"] input,
  html[data-theme="light"] select,
  html[data-theme="light"] textarea{
    background: rgba(255,255,255,.86);
    border:1px solid rgba(2,6,23,.12);
    color: var(--text);
  }

  html[data-theme="light"] .chip,
  html[data-theme="light"] .pill,
  html[data-theme="light"] .mini,
  html[data-theme="light"] .item,
  html[data-theme="light"] .tab{
    background: rgba(255,255,255,.75);
  }

  html[data-theme="light"] .nav{
    background: rgba(245,247,255,.92);
    border-top:1px solid rgba(2,6,23,.10);
  }

  /* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö ‚Äú‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‚Äù ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á */
  html[data-theme="light"] .sub,
  html[data-theme="light"] .note,
  html[data-theme="light"] label{
    color: var(--muted);
  }

  html[data-theme="light"] .chip{
    color: var(--muted);
    border-color: rgba(2,6,23,.12);
  }

  html[data-theme="light"] .tab{
    color: rgba(2,6,23,.72);
    border-color: rgba(2,6,23,.12);
  }
  html[data-theme="light"] .tab.active{ color:#0b1220; }

  /* ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô/‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏±‡∏î */
  html[data-theme="light"] .warnbox{
    border:1px dashed rgba(217,119,6,.55);
    background: var(--bg-warn);
    color: var(--on-warn);
  }
  html[data-theme="light"] .okbox{
    border:1px dashed rgba(22,163,74,.55);
    background: var(--bg-ok);
    color: var(--on-ok);
  }

  /* ‚úÖ ‡πÅ‡∏ö‡∏î‡∏à‡πå ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏±‡∏î */
  html[data-theme="light"] .badge{
    background: rgba(255,255,255,.86);
    border-color: rgba(2,6,23,.12);
    color: #0b1220;
  }
  html[data-theme="light"] .b-ok{
    background: rgba(22,163,74,.10);
    border-color: rgba(22,163,74,.40);
    color: var(--on-ok);
  }
  html[data-theme="light"] .b-warn{
    background: rgba(217,119,6,.12);
    border-color: rgba(217,119,6,.40);
    color: var(--on-warn);
  }
  html[data-theme="light"] .b-danger{
    background: rgba(220,38,38,.10);
    border-color: rgba(220,38,38,.40);
    color: var(--on-danger);
  }
  html[data-theme="light"] .b-info{
    background: rgba(37,99,235,.10);
    border-color: rgba(37,99,235,.35);
    color: var(--on-info);
  }

  /* ‚úÖ ‡∏õ‡∏∏‡πà‡∏°/‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢ ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
  html[data-theme="light"] .btn.outline{
    border-color: rgba(2,6,23,.18);
  }
  html[data-theme="light"] .smallbtn{
    background: rgba(255,255,255,.75);
    border-color: rgba(2,6,23,.14);
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", Arial;
    background:
      radial-gradient(1200px 600px at 40% -20%, rgba(14,167,90,.25), transparent 60%),
      radial-gradient(1200px 600px at 110% 10%, rgba(37,99,235,.25), transparent 55%),
      radial-gradient(900px 600px at -10% 100%, rgba(168,85,247,.22), transparent 55%),
      var(--bg);
    color:var(--text);
    padding-bottom:92px;
  }

  .wrap{max-width:920px;margin:0 auto;padding:16px 14px;}
  .topbar{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:14px 12px 8px;
  }
  .brand{display:flex;align-items:center;gap:10px;}
  .logo{
    width:40px;height:40px;border-radius:14px;
    background: linear-gradient(145deg, rgba(14,167,90,.95), rgba(37,99,235,.9));
    display:grid;place-items:center;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    font-size:20px;
  }
  h1{font-size:20px;margin:0}
  .sub{color:var(--muted);font-size:12px;margin-top:2px}
  .chip{
    border:1px solid var(--line);
    padding:8px 10px;border-radius:999px;
    display:flex;gap:8px;align-items:center;
    background: rgba(255,255,255,.03);
    font-size:12px;color:var(--muted);
    white-space:nowrap;
  }
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    border:1px solid var(--line);
    padding:7px 10px;border-radius:999px;
    background: rgba(255,255,255,.03);
    color:var(--text);
    font-size:12px;
    cursor:pointer;
    user-select:none;
    white-space:nowrap;
  }
  .pill b{font-weight:800}
  .grid{display:grid;gap:12px;}
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid var(--line);
    border-radius:16px;
    padding:14px;
    box-shadow: 0 16px 38px rgba(0,0,0,.22);
  }
  .card h2{
    margin:0 0 10px;
    font-size:16px;
    display:flex;gap:8px;align-items:center;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1}
  label{font-size:12px;color:var(--muted);display:block;margin:8px 0 6px}
  input,select,textarea{
    width:100%;
    background: rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.12);
    color:var(--text);
    border-radius:12px;
    padding:12px 12px;
    font-size:14px;
    outline:none;
  }
  textarea{min-height:72px;resize:vertical}
  input::placeholder, textarea::placeholder{color:rgba(234,240,255,.35)}
  .btn{
    border:none;border-radius:14px;
    padding:12px 14px;
    font-weight:700;
    color:white;
    width:100%;
    cursor:pointer;
    display:flex;align-items:center;justify-content:center;gap:10px;
    transition:.15s transform;
  }
  .btn:active{transform:scale(.98)}
  .btn.g1{background:linear-gradient(180deg, rgba(14,167,90,1), rgba(12,138,76,1))}
  .btn.g2{background:linear-gradient(180deg, rgba(37,99,235,1), rgba(29,78,216,1))}
  .btn.g3{background:linear-gradient(180deg, rgba(245,158,11,1), rgba(217,119,6,1))}
  .btn.g4{background:linear-gradient(180deg, rgba(168,85,247,1), rgba(126,34,206,1))}
  .btn.outline{
    background:transparent;
    border:1px solid rgba(255,255,255,.16);
    color:var(--text);
    font-weight:650;
  }
  .kpi{
    display:grid;gap:10px;
    grid-template-columns: 1fr 1fr;
  }
  .mini{
    border:1px solid var(--line);
    background: rgba(255,255,255,.03);
    border-radius:14px;
    padding:10px 12px;
  }
  .mini .t{color:var(--muted);font-size:12px}
  .mini .v{font-size:16px;font-weight:800;margin-top:4px}
  .mini .s{font-size:12px;color:var(--muted);margin-top:4px}
  .badge{
    display:inline-flex;align-items:center;gap:6px;
    border-radius:999px;padding:6px 10px;
    font-size:12px;font-weight:700;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.2);
    white-space:nowrap;
  }
  .b-ok{border-color: rgba(34,197,94,.5); color:var(--on-ok)}
  .b-warn{border-color: rgba(245,158,11,.55); color:var(--on-warn)}
  .b-danger{border-color: rgba(239,68,68,.55); color:var(--on-danger)}
  .b-info{border-color: rgba(37,99,235,.55); color:var(--on-info)}
  .list{margin:0;padding:0;list-style:none}
  .item{
    border:1px solid var(--line);
    background: rgba(255,255,255,.03);
    border-radius:14px;
    padding:10px 12px;
    margin-top:10px;
  }
  .item .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
  .item .title{font-weight:800}
  .item .meta{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.35}
  .item .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .smallbtn{
    padding:8px 10px;border-radius:12px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.18);
    color:var(--text);
    font-weight:650;
    cursor:pointer;
    font-size:12px;
  }
  .smallbtn.ok{border-color: rgba(34,197,94,.5)}
  .smallbtn.danger{border-color: rgba(239,68,68,.55)}
  .smallbtn.warn{border-color: rgba(245,158,11,.55)}

  /* bottom nav */
  .nav{
    position:fixed;left:0;right:0;bottom:0;
    padding:10px 12px calc(10px + env(safe-area-inset-bottom));
    background: rgba(10,16,30,.84);
    backdrop-filter: blur(12px);
    border-top:1px solid rgba(255,255,255,.08);
  }
  .tabs{display:grid;grid-template-columns: repeat(4,1fr);gap:10px;max-width:920px;margin:0 auto;}
  .tab{
    border:1px solid rgba(255,255,255,.12);
    border-radius:14px;
    padding:10px 8px;
    text-align:center;
    font-weight:800;
    font-size:12px;
    color:rgba(234,240,255,.75);
    background: rgba(255,255,255,.03);
    cursor:pointer;
    user-select:none;
  }
  .tab .dot{
    width:8px;height:8px;border-radius:99px;margin:0 auto 6px;
    opacity:.8;
  }
  .tab.active{color:white}
  .tab.active.g1{background: rgba(14,167,90,.18); border-color: rgba(14,167,90,.45)}
  .tab.active.g2{background: rgba(37,99,235,.18); border-color: rgba(37,99,235,.45)}
  .tab.active.g3{background: rgba(245,158,11,.18); border-color: rgba(245,158,11,.45)}
  .tab.active.g4{background: rgba(168,85,247,.18); border-color: rgba(168,85,247,.45)}

  .dot.g1{background:var(--g1)}
  .dot.g2{background:var(--g2)}
  .dot.g3{background:var(--g3)}
  .dot.g4{background:var(--g4)}

  .muted{color:var(--muted)}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .two{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
  .hide{display:none !important}
  .note{font-size:12px;color:var(--muted);line-height:1.45}
  .warnbox{
    border:1px dashed rgba(245,158,11,.55);
    background: var(--bg-warn);
    border-radius:14px;
    padding:10px 12px;
    color: var(--on-warn);
    font-size:12px;
    line-height:1.45;
  }
  .okbox{
    border:1px dashed rgba(34,197,94,.55);
    background: var(--bg-ok);
    border-radius:14px;
    padding:10px 12px;
    color: var(--on-ok);
    font-size:12px;
    line-height:1.45;
  }

  /* Timeline */
  .tl-top{
    display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;
  }
  .progress{
    height:10px;border-radius:999px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.18);
    overflow:hidden;
    flex:1;
    min-width:160px;
  }
  .progress > div{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(14,167,90,1), rgba(37,99,235,1));
  }
  .tl-item{
    position:relative;
    padding-left:16px;
  }
  .tl-item::before{
    content:"";
    position:absolute;
    left:4px; top:16px;
    width:8px;height:8px;border-radius:999px;
    background: rgba(255,255,255,.35);
    border:1px solid var(--line);
  }
  .tl-item.done::before{ background: rgba(34,197,94,.9); }
  .tl-item.today::before{ background: rgba(245,158,11,.95); }
  .tl-item.overdue::before{ background: rgba(239,68,68,.95); }
  .tl-item .meta b{font-weight:800}

  @media (min-width:760px){
    .grid{grid-template-columns: 1.1fr .9fr;}
  }
</style>

</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">üå±</div>
        <div>
          <h1>‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏ú‡∏±‡∏Å</h1>
          <div class="sub" id="nowLine">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‚Ä¶</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <div class="chip" id="cycleChip">‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å: <b id="activeCycleName">‚Äî</b></div>
        <button class="pill" id="btnTheme" type="button" title="‡∏™‡∏•‡∏±‡∏ö‡∏ò‡∏µ‡∏°">
          üåì <b id="themeLabel">‡∏£‡∏∞‡∏ö‡∏ö</b>
        </button>
      </div>
    </div>

    <!-- PAGE: TODAY -->
    <section id="page-today">
      <div class="grid">
        <div class="card">
          <h2>‚úÖ ‡∏á‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á)</h2>

          <div class="kpi">
            <div class="mini">
              <div class="t">‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î</div>
              <div class="v" id="nextTaskTitle">‚Äî</div>
              <div class="s" id="nextTaskMeta">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</div>
            </div>
            <div class="mini">
              <div class="t">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤</div>
              <div class="v" id="countdown">‚Äî</div>
              <div class="s" id="countdownHint">‚Äî</div>
            </div>
          </div>

          <div class="hr"></div>
          <div class="row">
            <button class="btn g1" id="btnMarkDone">‚úì ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
          </div>
          <div class="note" style="margin-top:10px">
            * ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ ‚Äú‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‚Äù (‡∏™‡∏±‡πà‡∏ô/‡πÄ‡∏™‡∏µ‡∏¢‡∏á) ‡∏ï‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ  
            ‡πÅ‡∏•‡∏∞‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏Æ‡∏™‡∏ï‡πå‡πÄ‡∏õ‡πá‡∏ô HTTPS + Add to Home Screen ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Notification ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ (‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‚Äù)
          </div>

          <div class="hr"></div>
          <h2>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Äú‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‚Äù</h2>
          <div id="todayList" class="note">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‚Ä¶</div>

          <div class="hr"></div>
          <h2>üó∫Ô∏è ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏à‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</h2>

          <div class="two">
            <div>
              <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏±‡∏Å (‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå)</label>
              <select id="timelinePlant"></select>
              <div class="note">‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏≤‡∏∞ ‚Üí ‡∏¢‡πâ‡∏≤‡∏¢ ‚Üí ‡∏î‡∏π‡πÅ‡∏• ‚Üí ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</div>
            </div>
            <div>
              <label>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</label>
              <div class="mini">
                <div class="t">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
                <div class="v" id="timelinePct">‚Äî</div>
                <div class="s" id="timelineEta">‚Äî</div>
              </div>
            </div>
          </div>

          <div class="tl-top" style="margin-top:10px">
            <div class="progress" aria-label="progress">
              <div id="timelineBar"></div>
            </div>
            <span class="badge b-info" id="timelineRange">‚Äî</span>
          </div>

          <div id="timelineList" class="note" style="margin-top:10px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå</div>
        </div>

        <div class="card">
          <h2>‚ö° ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏£‡πá‡∏ß</h2>
          <div class="mini">
            <div class="t">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</div>
            <div class="v" id="systemStatus">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
            <div class="s muted" id="systemSub">‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Local Storage (‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä)</div>
          </div>

          <div class="hr"></div>
          <div class="warnbox">
            <b>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Notification ‡∏ö‡∏ô iPhone</b><br/>
            ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå index.html ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (file://) ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ  
            ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡πá‡∏ö HTTPS ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô PWA (Add to Home Screen) ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
          </div>

          <div class="hr"></div>
          <button class="btn outline" id="btnExport">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (JSON)</button>
          <button class="btn outline" id="btnImport" style="margin-top:10px">‚¨ÜÔ∏è ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (JSON)</button>
          <input id="fileImport" type="file" accept="application/json" class="hide" />
          <div class="note" style="margin-top:10px">‡πÉ‡∏ä‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö</div>
        </div>
      </div>
    </section>

    <!-- PAGE: CYCLES -->
    <section id="page-cycles" class="hide">
      <div class="card">
        <h2>üß© ‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
        <div class="two">
          <div>
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å</label>
            <select id="cycleSelect"></select>
            <div class="note" id="cycleInfo"></div>
          </div>
          <div>
            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ)</label>
            <input id="cycleNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏ñ‡∏° ‡∏á‡∏≠‡∏Å 75% / ‡∏õ‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πâ‡∏≤" />
            <button class="btn g2" style="margin-top:10px" id="btnSaveCycleNote">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</button>
          </div>
        </div>

        <div class="hr"></div>
        <h2>‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
        <div class="two">
          <div>
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å</label>
            <input id="newCycleName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏ö‡∏ä‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡πÅ‡∏ñ‡∏° / ‡∏£‡∏≠‡∏ö‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 1" />
          </div>
          <div>
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° (‡πÑ‡∏ó‡∏¢)</label>
            <input id="newCycleStart" type="date" />
          </div>
        </div>
        <div class="two">
          <div>
            <label>% ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏á‡∏≠‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏ú‡∏∑‡πà‡∏≠)</label>
            <input id="newCycleGerm" type="number" min="1" max="100" placeholder="‡πÄ‡∏ä‡πà‡∏ô 75" />
            <div class="note">‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å ‡∏à‡∏∞‡πÉ‡∏ä‡πâ 75%</div>
          </div>
          <div>
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏∏‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô 48 ‡∏´‡∏•‡∏∏‡∏°)</label>
            <input id="newCycleTargetHoles" type="number" min="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 48" />
            <div class="note">‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‚Äú‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏≤‡∏∞‡∏Å‡∏µ‡πà‡∏´‡∏•‡∏∏‡∏°‚Äù</div>
          </div>
        </div>
        <button class="btn g2" id="btnCreateCycle">Ôºã ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å</button>
      </div>

      <div class="card">
        <h2>ü•¨ ‡∏ú‡∏±‡∏Å‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å‡∏ô‡∏µ‡πâ + ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‚Äú‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏ú‡∏∑‡πà‡∏≠‚Äù</h2>

        <div class="two">
          <div>
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏±‡∏Å</label>
            <select id="plantSelect"></select>
            <div class="note">‡∏°‡∏µ ‚Äú‡∏™‡∏•‡∏±‡∏î‡∏°‡∏¥‡∏Å‡∏ã‡πå‚Äù ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‚Äù</div>
          </div>
          <div>
            <label>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏Å‡∏µ‡πà‡∏´‡∏•‡∏∏‡∏° (‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢)</label>
            <input id="desiredHoles" type="number" min="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 48" />
          </div>
        </div>

        <div class="two">
          <div>
            <label>% ‡∏á‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏ú‡∏±‡∏Å‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å)</label>
            <input id="plantGerm" type="number" min="1" max="100" placeholder="‡πÄ‡∏ä‡πà‡∏ô 75" />
          </div>
          <div>
            <label>‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
            <div class="mini">
              <div class="t">‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏≤‡∏∞</div>
              <div class="v" id="calcSow">‚Äî</div>
              <div class="s" id="calcExtra">‚Äî</div>
            </div>
          </div>
        </div>

        <button class="btn g2" id="btnAddPlantToCycle">Ôºã ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ ‚Äú‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å‡∏ô‡∏µ‡πâ‚Äù</button>

        <div class="hr"></div>
        <h2>üìå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏±‡∏Å‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</h2>
        <div id="cyclePlantsList" class="note">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏±‡∏Å‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</div>
      </div>

      <div class="card">
        <h2>üóìÔ∏è ‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)</h2>
        <div class="note">
          ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å ‚Äú‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏≤‡∏∞‚Äù ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î/‡πÉ‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß  
          ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ ‚Äú‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‚Äù ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </div>
        <div id="tasksList" class="note">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</div>
      </div>
    </section>

    <!-- PAGE: LOG -->
    <section id="page-log" class="hide">
      <div class="grid">
        <div class="card">
          <h2>üß™ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
          <div class="two">
            <div>
              <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏±‡∏Å</label>
              <select id="healthPlant"></select>
            </div>
            <div>
              <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö</label>
              <select id="leafStatus">
                <option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏à‡∏£‡∏¥‡∏á">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏à‡∏£‡∏¥‡∏á</option>
                <option value="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡πÉ‡∏ö‡∏à‡∏£‡∏¥‡∏á">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡πÉ‡∏ö‡∏à‡∏£‡∏¥‡∏á</option>
                <option value="‡πÉ‡∏ö‡∏à‡∏£‡∏¥‡∏á 2‚Äì3 ‡πÉ‡∏ö">‡πÉ‡∏ö‡∏à‡∏£‡∏¥‡∏á 2‚Äì3 ‡πÉ‡∏ö</option>
                <option value="‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏õ‡∏Å‡∏ï‡∏¥">‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏õ‡∏Å‡∏ï‡∏¥</option>
                <option value="‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß/‡∏ä‡πâ‡∏≥">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏µ‡πà‡∏¢‡∏ß/‡∏ä‡πâ‡∏≥</option>
                <option value="‡∏°‡∏µ‡∏£‡∏≤/‡πÇ‡∏Ñ‡∏ô‡πÄ‡∏ô‡πà‡∏≤">‡∏°‡∏µ‡∏£‡∏≤/‡πÇ‡∏Ñ‡∏ô‡πÄ‡∏ô‡πà‡∏≤</option>
              </select>
            </div>
          </div>
          <div class="two">
            <div>
              <label>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C) (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
              <input id="tempC" type="number" step="0.1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 29" />
            </div>
            <div>
              <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ)</label>
              <input id="healthDate" type="date" />
            </div>
          </div>
          <div class="two">
            <div>
              <label>‡πÄ‡∏ß‡∏•‡∏≤ (‡πÑ‡∏ó‡∏¢)</label>
              <input id="healthTime" type="time" step="1"/>
            </div>
            <div>
              <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <input id="healthNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏µ / ‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤‡∏£‡∏∞‡∏ö‡∏≤‡∏¢ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ" />
            </div>
          </div>
          <button class="btn g3" id="btnSaveHealth">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏†‡∏≤‡∏û</button>
        </div>

        <div class="card">
          <h2>üìí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥ (‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£/‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô)</h2>

          <div class="two">
            <div>
              <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏±‡∏Å</label>
              <select id="actPlant"></select>
            </div>
            <div>
              <label>‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£</label>
              <select id="actType">
                <option value="‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î">‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î</option>
                <option value="‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô/‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥">‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô/‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥</option>
                <option value="‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®">‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</option>
                <option value="‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏á">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏á</option>
                <option value="‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡πà‡∏≠‡∏ô">‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡πà‡∏≠‡∏ô</option>
                <option value="‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡∏ñ‡πâ‡∏ß‡∏¢/‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤">‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡∏ñ‡πâ‡∏ß‡∏¢/‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</option>
                <option value="‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏≤‡∏ß‡πÄ‡∏ß‡∏≠‡∏£‡πå">‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏≤‡∏ß‡πÄ‡∏ß‡∏≠‡∏£‡πå</option>
                <option value="‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏£‡∏∞‡∏ö‡∏ö">‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏£‡∏∞‡∏ö‡∏ö</option>
                <option value="‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</option>
                <option value="‡∏≠‡∏∑‡πà‡∏ô ‡πÜ">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
              </select>
            </div>
          </div>

          <div class="two">
            <div>
              <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ)</label>
              <input id="actDate" type="date" />
            </div>
            <div>
              <label>‡πÄ‡∏ß‡∏•‡∏≤ (‡πÑ‡∏ó‡∏¢)</label>
              <input id="actTime" type="time" step="1"/>
            </div>
          </div>

          <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
          <input id="actNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏î‡∏ü‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô / ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤ 3 ‡∏ß‡∏±‡∏ô" />

          <button class="btn g3" id="btnSaveAct">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</button>

          <div class="hr"></div>
          <h2>üóÇÔ∏è ‡πÅ‡∏Å‡πâ‡∏á‡∏≤‡∏ô/‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏á‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏à‡∏£‡∏¥‡∏á)</h2>
          <div class="note">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ</div>
          <div class="two">
            <div>
              <label>‡∏á‡∏≤‡∏ô</label>
              <select id="taskEditSelect"></select>
            </div>
            <div>
              <label>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡∏°‡πà</label>
              <input id="taskEditDate" type="datetime-local" />
            </div>
          </div>
          <div class="two">
            <button class="btn outline" id="btnTaskSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏á‡∏≤‡∏ô</button>
            <button class="btn outline" id="btnTaskDone">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
        <div id="history" class="note">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
      </div>
    </section>

    <!-- PAGE: SETTINGS -->
    <section id="page-settings" class="hide">
      <div class="card">
        <h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>

        <div class="okbox">
          <b>‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢ 100%</b> ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ Asia/Bangkok ‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ
        </div>

        <div class="hr"></div>
        <h2>üåì ‡∏ò‡∏µ‡∏°‡∏™‡∏µ</h2>
        <div class="two">
          <div>
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏µ‡∏°</label>
            <select id="themeSelect">
              <option value="system">‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</option>
              <option value="dark">‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î</option>
              <option value="light">‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á</option>
            </select>
            <div class="note">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° üåì ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ</div>
          </div>
          <div>
            <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ò‡∏µ‡∏°</label>
            <div class="mini">
              <div class="t">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
              <div class="v" id="themeStatus">‚Äî</div>
              <div class="s" id="themeStatusSub">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <h2>ü•ó ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å</h2>
        <div class="two">
          <div>
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà</label>
            <input id="newPlantName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß / ‡∏Ñ‡∏≠‡∏™ / ‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ" />
          </div>
          <div>
            <label>% ‡∏á‡∏≠‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡πâ)</label>
            <input id="newPlantGerm" type="number" min="1" max="100" placeholder="‡πÄ‡∏ä‡πà‡∏ô 75" />
          </div>
        </div>
        <button class="btn g4" id="btnAddPlant">Ôºã ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å</button>
        <div class="hr"></div>
        <div id="plantManageList" class="note">‚Äî</div>

        <div class="hr"></div>
        <h2>üîî ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2>
        <div class="warnbox">
          <b>‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</b>: ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‚Äù (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡πÑ‡∏ß‡πâ) ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡∏±‡πà‡∏ô/‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤<br/>
          <b>‡πÇ‡∏´‡∏°‡∏î PWA + HTTPS</b>: ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Notification ‡πÑ‡∏î‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ <code>manifest.json</code> + <code>sw.js</code>)
        </div>
        <div class="two" style="margin-top:10px">
          <button class="btn outline" id="btnTestInAppAlert">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ (‡∏™‡∏±‡πà‡∏ô/‡πÄ‡∏™‡∏µ‡∏¢‡∏á)</button>
          <button class="btn outline" id="btnHowToPWA">‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏õ‡∏¥‡∏î Notification ‡∏à‡∏£‡∏¥‡∏á (‡∏≠‡πà‡∏≤‡∏ô)</button>
        </div>

        <div class="hr"></div>
        <h2>üßπ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</h2>
        <button class="btn outline" id="btnReset" style="border-color: rgba(239,68,68,.6)">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏∞‡∏ß‡∏±‡∏á!)</button>
      </div>

      <div class="card">
        <h2>üìå ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏ã‡∏ü‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô iPhone (‡∏ü‡∏£‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡πÅ‡∏≠‡∏õ‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô)</h2>
        <ol class="note">
          <li>‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ <b>‡πÑ‡∏ü‡∏•‡πå (Files)</b></li>
          <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà <b>‡∏ö‡∏ô iPhone ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</b> ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ä‡∏∑‡πà‡∏≠ ‚ÄúFarmApp‚Äù</li>
          <li>‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå FarmApp ‚Üí ‡∏Å‡∏î <b>‚Ä¶</b> ‚Üí <b>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (New Document)</b></li>
          <li>‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠ <b>index.html</b></li>
          <li>‡πÅ‡∏ï‡∏∞‡πÑ‡∏ü‡∏•‡πå index.html ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ <b>Safari</b></li>
          <li>‡πÉ‡∏ô Safari ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏£‡πå ‚Üí <b>Add to Home Screen</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏õ</li>
        </ol>
      </div>
    </section>
  </div>

  <!-- bottom nav -->
  <div class="nav">
    <div class="tabs">
      <div class="tab g1 active" data-go="today"><div class="dot g1"></div>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="tab g2" data-go="cycles"><div class="dot g2"></div>‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å</div>
      <div class="tab g3" data-go="log"><div class="dot g3"></div>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
      <div class="tab g4" data-go="settings"><div class="dot g4"></div>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
    </div>
  </div>

<script>
/* =========================
   TIME (THAILAND) 100%
========================= */
function getThaiNow() {
  const now = new Date();
  const date = now.toLocaleDateString("sv-SE", { timeZone: "Asia/Bangkok" }); // YYYY-MM-DD
  const time = now.toLocaleTimeString("th-TH", {
    timeZone: "Asia/Bangkok",
    hour: "2-digit", minute: "2-digit", second: "2-digit"
  });
  const hhmmss = time;
  return { now, date, time: hhmmss };
}
function toThaiDateTimeLocalInput(isoLikeDate, hhmmss){
  const [hh,mm] = (hhmmss || "00:00:00").split(":");
  return `${isoLikeDate}T${hh}:${mm}`;
}
function formatThaiHuman(dateYYYYMMDD, timeHHMMSS){
  return `${dateYYYYMMDD} ${timeHHMMSS}`;
}
function parseDateTimeToMs(dateYYYYMMDD, timeHHMMSS){
  const [hh,mm,ss] = (timeHHMMSS || "00:00:00").split(":");
  const s = `${dateYYYYMMDD}T${hh}:${mm}:${ss}+07:00`;
  return new Date(s).getTime();
}

/* =========================
   STORAGE
========================= */
const LS_KEY = "farm_planner_v1";
function loadDB(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function saveDB(){
  localStorage.setItem(LS_KEY, JSON.stringify(db));
}
function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36);
}

/* =========================
   DEFAULTS
========================= */
const DEFAULT_PLANTS = [
  { id:"p_mix", name:"‡∏™‡∏•‡∏±‡∏î‡∏°‡∏¥‡∏Å‡∏ã‡πå", defaultGerm:75 },
  { id:"p_green", name:"‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", defaultGerm:80 },
  { id:"p_redoak", name:"‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ", defaultGerm:75 },
  { id:"p_greenoak", name:"‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏≠‡πä‡∏Ñ", defaultGerm:75 },
  { id:"p_cos", name:"‡∏Ñ‡∏≠‡∏™", defaultGerm:80 },
  { id:"p_butter", name:"‡∏ö‡∏±‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏Æ‡∏î", defaultGerm:75 },
  { id:"p_kale", name:"‡πÄ‡∏Ñ‡∏•", defaultGerm:75 },
  { id:"p_bok", name:"‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏Æ‡πà‡∏≠‡∏á‡πÄ‡∏ï‡πâ", defaultGerm:85 },
  { id:"p_rocket", name:"‡∏£‡πá‡∏≠‡∏Å‡πÄ‡∏Å‡πá‡∏ï", defaultGerm:70 }
];

/*
  TIMELINE TEMPLATE (days after sowing)
  ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Å‡πá‡∏ö" ‡πÅ‡∏•‡∏∞ "‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß" ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
*/
const TASK_TEMPLATE = [
  { day:0,  title:"‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î", detail:"‡∏Å‡∏î‡∏ü‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô / ‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏°‡∏•‡πá‡∏î / ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤", type:"‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î" },
  { day:1,  title:"‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô", detail:"‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏±‡πâ‡∏ô ‡πÜ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ + ‡∏û‡∏£‡∏°‡∏ñ‡πâ‡∏≤‡πÅ‡∏´‡πâ‡∏á", type:"‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô/‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥" },
  { day:2,  title:"‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô", detail:"‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ (‡∏≠‡∏¢‡πà‡∏≤‡πÅ‡∏â‡∏∞)", type:"‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô/‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥" },
  { day:3,  title:"‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®", detail:"‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1‚Äì2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏•‡∏î‡∏£‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏á‡∏≠‡∏Å‡∏Å‡πá‡∏ä‡∏∑‡πâ‡∏ô‡πÑ‡∏ß‡πâ)", type:"‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®" },
  { day:4,  title:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏á‡∏≠‡πà‡∏≠‡∏ô", detail:"‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏á‡πÄ‡∏ä‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô ‡πÜ / ‡∏≠‡∏¢‡πà‡∏≤‡πÇ‡∏î‡∏ô‡πÅ‡∏î‡∏î‡πÅ‡∏£‡∏á", type:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏á" },
  { day:7,  title:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡πà‡∏≠‡∏ô", detail:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πã‡∏¢ AB ‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å (‡πÄ‡∏ä‡πà‡∏ô 1/4) ‡∏ñ‡πâ‡∏≤‡∏£‡∏≤‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏ô", type:"‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡πà‡∏≠‡∏ô" },
  { day:10, title:"‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡∏ñ‡πâ‡∏ß‡∏¢/‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤", detail:"‡∏ñ‡πâ‡∏≤‡πÉ‡∏ö‡∏à‡∏£‡∏¥‡∏á 2 ‡πÉ‡∏ö + ‡∏£‡∏≤‡∏Å‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á", type:"‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡∏ñ‡πâ‡∏ß‡∏¢/‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤" },
  { day:14, title:"‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏≤‡∏ß‡πÄ‡∏ß‡∏≠‡∏£‡πå", detail:"‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏û‡∏≠/‡∏£‡∏≤‡∏Å‡∏¢‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á‡∏ô‡πâ‡∏≥", type:"‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏≤‡∏ß‡πÄ‡∏ß‡∏≠‡∏£‡πå" },
  { day:21, title:"‡∏ï‡∏£‡∏ß‡∏à EC/‡∏ô‡πâ‡∏≥/‡∏ï‡∏∞‡πÑ‡∏Ñ‡∏£‡πà", detail:"‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏õ‡∏∏‡πã‡∏¢/‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô/‡∏Å‡∏±‡∏ô‡πÅ‡∏™‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏±‡∏á", type:"‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏£‡∏∞‡∏ö‡∏ö" },
  { day:24, title:"‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß", detail:"‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏û‡∏∑‡∏ä/‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î/‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏†‡∏≤‡∏ä‡∏ô‡∏∞", type:"‡∏≠‡∏∑‡πà‡∏ô ‡πÜ" },
  { day:28, title:"‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß", detail:"‡∏ï‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö/‡∏•‡πâ‡∏≤‡∏á/‡∏ä‡∏±‡πà‡∏á/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏• ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏£‡∏∞‡∏ö‡∏ö", type:"‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß" }
];

/* =========================
   DB SCHEMA
========================= */
let db = loadDB();
if(!db){
  const thai = getThaiNow();
  db = {
    version:1,
    settings: {
      timezone: "Asia/Bangkok",
      inAppAlert: { enabled:true, vibrate:true, sound:true },
      themeMode: "system" // system | dark | light
    },
    plants: DEFAULT_PLANTS,
    cycles: [
      {
        id:"c_first",
        name:"‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å",
        startDate: thai.date,
        note:"‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏ñ‡∏° ‡∏á‡∏≠‡∏Å 75%",
        germDefault:75,
        targetHoles:48,
        plantsInCycle: [],
        tasks: [],
        createdAt: formatThaiHuman(thai.date, thai.time)
      }
    ],
    activeCycleId: "c_first",
    logs: {
      actions: [],
      health: []
    }
  };
  saveDB();
}else{
  // ‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏™‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤
  db.settings = db.settings || {};
  db.settings.inAppAlert = db.settings.inAppAlert || { enabled:true, vibrate:true, sound:true };
  if(!db.settings.themeMode) db.settings.themeMode = "system";
  saveDB();
}

/* =========================
   HELPERS
========================= */
function getActiveCycle(){
  return db.cycles.find(c=>c.id===db.activeCycleId) || db.cycles[0];
}
function getPlantById(pid){
  return db.plants.find(p=>p.id===pid);
}
function calcSow(desired, germPercent){
  const g = Math.max(1, Math.min(100, Number(germPercent || 75)));
  const d = Math.max(1, Number(desired || 1));
  const sow = Math.ceil(d / (g/100));
  const extra = sow - d;
  return { sow, extra, g, d };
}
function daysAfter(dateYYYYMMDD, addDays){
  const base = new Date(`${dateYYYYMMDD}T00:00:00+07:00`).getTime();
  const ms = base + (addDays*24*60*60*1000);
  const dt = new Date(ms);
  const y = dt.toLocaleDateString("sv-SE", { timeZone:"Asia/Bangkok" });
  return y;
}
function msToHuman(ms){
  if(ms <= 0) return "‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß";
  const s = Math.floor(ms/1000);
  const d = Math.floor(s/86400);
  const h = Math.floor((s%86400)/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  if(d>0) return `${d} ‡∏ß‡∏±‡∏ô ${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
  if(h>0) return `${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
  if(m>0) return `${m} ‡∏ô‡∏≤‡∏ó‡∏µ ${sec} ‡∏ß‡∏¥`;
  return `${sec} ‡∏ß‡∏¥`;
}
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   THEME LOGIC (System/Dark/Light)
========================= */
const btnTheme = document.getElementById("btnTheme");
const themeLabel = document.getElementById("themeLabel");
const themeSelect = document.getElementById("themeSelect");
const themeStatus = document.getElementById("themeStatus");
const themeStatusSub = document.getElementById("themeStatusSub");

const mqlDark = window.matchMedia ? window.matchMedia("(prefers-color-scheme: dark)") : null;

function getResolvedTheme(mode){
  if(mode === "dark") return "dark";
  if(mode === "light") return "light";
  // system
  const isDark = mqlDark ? mqlDark.matches : true;
  return isDark ? "dark" : "light";
}
function applyTheme(mode){
  const resolved = getResolvedTheme(mode);
  document.documentElement.setAttribute("data-theme", resolved);

  // label
  const label = mode==="system" ? "‡∏£‡∏∞‡∏ö‡∏ö" : (mode==="dark" ? "‡∏°‡∏∑‡∏î" : "‡∏™‡∏ß‡πà‡∏≤‡∏á");
  if(themeLabel) themeLabel.textContent = label;

  // settings ui
  if(themeSelect) themeSelect.value = mode;
  if(themeStatus) themeStatus.textContent = (resolved==="dark" ? "‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î" : "‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á");
  if(themeStatusSub) themeStatusSub.textContent =
    mode==="system" ? "‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" : "‡∏•‡πá‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";

  // theme-color
  const meta = document.querySelector('meta[name="theme-color"]');
  if(meta){
    meta.setAttribute("content", resolved==="dark" ? "#0ea75a" : "#2563eb");
  }
}
function setThemeMode(mode){
  db.settings.themeMode = mode;
  saveDB();
  applyTheme(mode);
}

function cycleThemeMode(){
  const cur = db.settings.themeMode || "system";
  const next = cur==="system" ? "dark" : cur==="dark" ? "light" : "system";
  setThemeMode(next);
}

if(btnTheme){
  btnTheme.addEventListener("click", cycleThemeMode);
}
if(themeSelect){
  themeSelect.addEventListener("change", ()=> setThemeMode(themeSelect.value));
}
if(mqlDark){
  const handler = ()=>{
    if((db.settings.themeMode || "system")==="system"){
      applyTheme("system");
      renderAll();
    }
  };
  if(mqlDark.addEventListener) mqlDark.addEventListener("change", handler);
  else if(mqlDark.addListener) mqlDark.addListener(handler);
}

// apply at start
applyTheme(db.settings.themeMode || "system");

/* =========================
   UI: NAV
========================= */
const pages = {
  today: document.getElementById("page-today"),
  cycles: document.getElementById("page-cycles"),
  log: document.getElementById("page-log"),
  settings: document.getElementById("page-settings"),
};
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    const go = t.dataset.go;
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active","g1","g2","g3","g4"));
    t.classList.add("active", "g"+(go==="today"?1:go==="cycles"?2:go==="log"?3:4));
    Object.values(pages).forEach(p=>p.classList.add("hide"));
    pages[go].classList.remove("hide");
    renderAll();
  });
});

/* =========================
   UI: ELEMENTS
========================= */
const nowLine = document.getElementById("nowLine");
const activeCycleName = document.getElementById("activeCycleName");

const nextTaskTitle = document.getElementById("nextTaskTitle");
const nextTaskMeta = document.getElementById("nextTaskMeta");
const countdown = document.getElementById("countdown");
const countdownHint = document.getElementById("countdownHint");
const btnMarkDone = document.getElementById("btnMarkDone");
const todayList = document.getElementById("todayList");

const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");
const fileImport = document.getElementById("fileImport");

const cycleSelect = document.getElementById("cycleSelect");
const cycleInfo = document.getElementById("cycleInfo");
const cycleNote = document.getElementById("cycleNote");
const btnSaveCycleNote = document.getElementById("btnSaveCycleNote");

const newCycleName = document.getElementById("newCycleName");
const newCycleStart = document.getElementById("newCycleStart");
const newCycleGerm = document.getElementById("newCycleGerm");
const newCycleTargetHoles = document.getElementById("newCycleTargetHoles");
const btnCreateCycle = document.getElementById("btnCreateCycle");

const plantSelect = document.getElementById("plantSelect");
const desiredHoles = document.getElementById("desiredHoles");
const plantGerm = document.getElementById("plantGerm");
const calcSowEl = document.getElementById("calcSow");
const calcExtraEl = document.getElementById("calcExtra");
const btnAddPlantToCycle = document.getElementById("btnAddPlantToCycle");
const cyclePlantsList = document.getElementById("cyclePlantsList");
const tasksList = document.getElementById("tasksList");

const healthPlant = document.getElementById("healthPlant");
const leafStatus = document.getElementById("leafStatus");
const tempC = document.getElementById("tempC");
const healthDate = document.getElementById("healthDate");
const healthTime = document.getElementById("healthTime");
const healthNote = document.getElementById("healthNote");
const btnSaveHealth = document.getElementById("btnSaveHealth");

const actPlant = document.getElementById("actPlant");
const actType = document.getElementById("actType");
const actDate = document.getElementById("actDate");
const actTime = document.getElementById("actTime");
const actNote = document.getElementById("actNote");
const btnSaveAct = document.getElementById("btnSaveAct");

const taskEditSelect = document.getElementById("taskEditSelect");
const taskEditDate = document.getElementById("taskEditDate");
const btnTaskSave = document.getElementById("btnTaskSave");
const btnTaskDone = document.getElementById("btnTaskDone");

const historyEl = document.getElementById("history");

const newPlantName = document.getElementById("newPlantName");
const newPlantGerm = document.getElementById("newPlantGerm");
const btnAddPlant = document.getElementById("btnAddPlant");
const plantManageList = document.getElementById("plantManageList");

const btnTestInAppAlert = document.getElementById("btnTestInAppAlert");
const btnHowToPWA = document.getElementById("btnHowToPWA");
const btnReset = document.getElementById("btnReset");

/* timeline elements */
const timelinePlant = document.getElementById("timelinePlant");
const timelineList = document.getElementById("timelineList");
const timelinePct = document.getElementById("timelinePct");
const timelineEta = document.getElementById("timelineEta");
const timelineBar = document.getElementById("timelineBar");
const timelineRange = document.getElementById("timelineRange");

function setDefaultDatesTimes(){
  const thai = getThaiNow();
  if(newCycleStart) newCycleStart.value = thai.date;
  if(healthDate) healthDate.value = thai.date;
  if(actDate) actDate.value = thai.date;
  const t = thai.time;
  if(healthTime) healthTime.value = t.slice(0,8);
  if(actTime) actTime.value = t.slice(0,8);
}
setDefaultDatesTimes();

/* =========================
   RENDER
========================= */
function renderHeader(){
  const thai = getThaiNow();
  nowLine.textContent = `‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢: ${thai.date} ‚Ä¢ ${thai.time}`;
  const c = getActiveCycle();
  activeCycleName.textContent = c?.name || "‚Äî";
}

function renderCycleSelect(){
  cycleSelect.innerHTML = "";
  db.cycles.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    if(c.id === db.activeCycleId) opt.selected = true;
    cycleSelect.appendChild(opt);
  });
  cycleSelect.onchange = ()=>{
    db.activeCycleId = cycleSelect.value;
    saveDB();
    renderAll();
  };

  const c = getActiveCycle();
  cycleNote.value = c.note || "";
  cycleInfo.innerHTML = `
    <div class="note">
      ‡πÄ‡∏£‡∏¥‡πà‡∏°: <b>${escapeHtml(c.startDate)}</b> ‚Ä¢
      ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏á‡∏≠‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: <b>${escapeHtml(c.germDefault || 75)}%</b> ‚Ä¢
      ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏´‡∏•‡∏∏‡∏°: <b>${escapeHtml(c.targetHoles || "-")}</b><br/>
      ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: <span class="muted">${escapeHtml(c.note || "-")}</span>
    </div>`;
}

function renderPlantOptions(){
  const opts = db.plants.slice().sort((a,b)=>a.name.localeCompare(b.name,"th"));

  function fill(selectEl){
    selectEl.innerHTML = "";
    opts.forEach(p=>{
      const o = document.createElement("option");
      o.value = p.id;
      o.textContent = p.name;
      selectEl.appendChild(o);
    });
  }
  fill(plantSelect);
  fill(healthPlant);
  fill(actPlant);

  const mix = db.plants.find(p=>p.name==="‡∏™‡∏•‡∏±‡∏î‡∏°‡∏¥‡∏Å‡∏ã‡πå") || db.plants.find(p=>p.id==="p_mix");
  if(mix){
    plantSelect.value = mix.id;
    healthPlant.value = mix.id;
    actPlant.value = mix.id;
  }
}

function renderCalc(){
  const c = getActiveCycle();
  const d = Number(desiredHoles.value || c.targetHoles || 48);
  const pid = plantSelect.value;
  const plant = getPlantById(pid);
  const g = plantGerm.value ? Number(plantGerm.value) : (plant?.defaultGerm || c.germDefault || 75);
  const r = calcSow(d, g);
  calcSowEl.textContent = `${r.sow} ‡∏´‡∏•‡∏∏‡∏°`;
  calcExtraEl.textContent = `‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏ú‡∏∑‡πà‡∏≠ ${r.extra} ‡∏´‡∏•‡∏∏‡∏° (‡∏á‡∏≠‡∏Å ${r.g}%)`;
}
desiredHoles.addEventListener("input", renderCalc);
plantGerm.addEventListener("input", renderCalc);
plantSelect.addEventListener("change", ()=>{
  const c = getActiveCycle();
  desiredHoles.value = String(c.targetHoles || 48);
  plantGerm.value = "";
  renderCalc();
});

function renderCyclePlants(){
  const c = getActiveCycle();
  if(!c.plantsInCycle?.length){
    cyclePlantsList.innerHTML = `<div class="note">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏±‡∏Å‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</div>`;
    return;
  }
  const items = c.plantsInCycle.map(pi=>{
    const p = getPlantById(pi.plantId);
    return `
      <div class="item">
        <div class="top">
          <div>
            <div class="title">${escapeHtml(p?.name || "‚Äî")}</div>
            <div class="meta">
              ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: <b>${pi.desired}</b> ‡∏´‡∏•‡∏∏‡∏° ‚Ä¢ ‡πÄ‡∏û‡∏≤‡∏∞: <b>${pi.sow}</b> ‡∏´‡∏•‡∏∏‡∏° (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ ${pi.extra}) ‚Ä¢ ‡∏á‡∏≠‡∏Å ${pi.germUsed}%<br/>
              ‡∏ß‡∏±‡∏ô‡πÄ‡∏û‡∏≤‡∏∞: <b>${escapeHtml(pi.sowDate || c.startDate)}</b>
            </div>
          </div>
          <span class="badge b-info">‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</span>
        </div>
        <div class="actions">
          <button class="smallbtn warn" onclick="removePlantFromCycle('${pi.id}')">‡∏•‡∏ö</button>
          <button class="smallbtn" onclick="regenTasksForPlant('${pi.id}')">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
        </div>
      </div>
    `;
  }).join("");

  cyclePlantsList.innerHTML = items;
}

function renderTasks(){
  const c = getActiveCycle();
  const all = (c.tasks || []).slice().sort((a,b)=>a.dueMs-b.dueMs);

  if(!all.length){
    tasksList.innerHTML = `<div class="note">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å‡∏Å‡πà‡∏≠‡∏ô)</div>`;
    taskEditSelect.innerHTML = `<option value="">‚Äî</option>`;
    return;
  }

  taskEditSelect.innerHTML = "";
  all.forEach(t=>{
    const p = getPlantById(t.plantId);
    const o = document.createElement("option");
    o.value = t.id;
    o.textContent = `${p?.name || "‚Äî"} ‚Ä¢ ${t.title} ‚Ä¢ ${t.dueDate} ${t.dueTime}`;
    taskEditSelect.appendChild(o);
  });

  tasksList.innerHTML = all.map(t=>{
    const p = getPlantById(t.plantId);
    const status = t.done ? `<span class="badge b-ok">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>` : `<span class="badge b-warn">‡∏£‡∏≠‡∏ó‡∏≥</span>`;
    return `
      <div class="item">
        <div class="top">
          <div>
            <div class="title">${escapeHtml(p?.name || "‚Äî")} ‚Äî ${escapeHtml(t.title)}</div>
            <div class="meta">
              ‡∏Å‡∏≥‡∏´‡∏ô‡∏î: <b>${escapeHtml(t.dueDate)} ${escapeHtml(t.dueTime)}</b><br/>
              ${escapeHtml(t.detail || "")}
            </div>
          </div>
          ${status}
        </div>
        <div class="actions">
          ${t.done ? "" : `<button class="smallbtn ok" onclick="markTaskDone('${t.id}')">‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>`}
          <button class="smallbtn" onclick="quickShiftTask('${t.id}', 1)">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô +1 ‡∏ß‡∏±‡∏ô</button>
          <button class="smallbtn" onclick="quickShiftTask('${t.id}', -1)">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô -1 ‡∏ß‡∏±‡∏ô</button>
        </div>
      </div>
    `;
  }).join("");
}

function renderHistory(){
  const c = getActiveCycle();
  const acts = db.logs.actions.filter(x=>x.cycleId===c.id);
  const healths = db.logs.health.filter(x=>x.cycleId===c.id);

  const merged = [
    ...acts.map(a=>({kind:"act", ...a, sortMs: parseDateTimeToMs(a.date, a.time)})),
    ...healths.map(h=>({kind:"health", ...h, sortMs: parseDateTimeToMs(h.date, h.time)})),
  ].sort((a,b)=>b.sortMs - a.sortMs).slice(0,30);

  if(!merged.length){
    historyEl.innerHTML = `<div class="note">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
    return;
  }

  historyEl.innerHTML = merged.map(x=>{
    const p = getPlantById(x.plantId);
    if(x.kind==="act"){
      return `
        <div class="item">
          <div class="top">
            <div>
              <div class="title">${escapeHtml(x.date)} ${escapeHtml(x.time)} ‚Äî ${escapeHtml(p?.name||"‚Äî")}</div>
              <div class="meta">‚Ü≥ ${escapeHtml(x.type)} ${x.note?`‚Ä¢ ${escapeHtml(x.note)}`:""}</div>
            </div>
            <span class="badge b-info">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</span>
          </div>
        </div>
      `;
    }else{
      return `
        <div class="item">
          <div class="top">
            <div>
              <div class="title">${escapeHtml(x.date)} ${escapeHtml(x.time)} ‚Äî ${escapeHtml(p?.name||"‚Äî")}</div>
              <div class="meta">‡πÉ‡∏ö: <b>${escapeHtml(x.leafStatus)}</b> ${x.tempC?`‚Ä¢ ${escapeHtml(x.tempC)}¬∞C`:""} ${x.note?`‚Ä¢ ${escapeHtml(x.note)}`:""}</div>
            </div>
            <span class="badge b-warn">‡∏™‡∏†‡∏≤‡∏û‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
          </div>
        </div>
      `;
    }
  }).join("");
}

function renderPlantManage(){
  const list = db.plants.slice().sort((a,b)=>a.name.localeCompare(b.name,"th"));
  plantManageList.innerHTML = list.map(p=>{
    return `
      <div class="item">
        <div class="top">
          <div>
            <div class="title">${escapeHtml(p.name)}</div>
            <div class="meta">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏á‡∏≠‡∏Å: <b>${escapeHtml(p.defaultGerm || "-")}%</b></div>
          </div>
          <span class="badge b-info">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
        </div>
        <div class="actions">
          ${p.id.startsWith("p_") ? "" : `<button class="smallbtn danger" onclick="deletePlant('${p.id}')">‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å</button>`}
        </div>
      </div>
    `;
  }).join("");
}

function renderToday(){
  const c = getActiveCycle();
  const thai = getThaiNow();
  const nowMs = parseDateTimeToMs(thai.date, thai.time);

  const pending = (c.tasks || []).filter(t=>!t.done).sort((a,b)=>a.dueMs-b.dueMs);
  const next = pending[0];

  if(!next){
    nextTaskTitle.textContent = "‚Äî";
    nextTaskMeta.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô";
    countdown.textContent = "‚Äî";
    countdownHint.textContent = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å‡∏Å‡πà‡∏≠‡∏ô";
    todayList.innerHTML = `<div class="note">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÑ‡∏î‡πâ)</div>`;
    btnMarkDone.disabled = true;
    btnMarkDone.style.opacity = .6;
    return;
  }

  btnMarkDone.disabled = false;
  btnMarkDone.style.opacity = 1;

  const p = getPlantById(next.plantId);
  nextTaskTitle.textContent = `${p?.name || "‚Äî"}: ${next.title}`;
  nextTaskMeta.textContent = `‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${next.dueDate} ${next.dueTime}`;

  const diff = next.dueMs - nowMs;
  countdown.textContent = msToHuman(diff);
  countdownHint.textContent = diff>0 ? "‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î" : "‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)";

  const startOfToday = parseDateTimeToMs(thai.date, "00:00:00");
  const endOfToday = parseDateTimeToMs(thai.date, "23:59:59");
  const dueToday = (c.tasks || []).filter(t=>!t.done && t.dueMs>=startOfToday && t.dueMs<=endOfToday);
  const overdue = (c.tasks || []).filter(t=>!t.done && t.dueMs<startOfToday);
  const allShow = [...overdue.sort((a,b)=>a.dueMs-b.dueMs), ...dueToday.sort((a,b)=>a.dueMs-b.dueMs)];

  todayList.innerHTML = allShow.length ? `
    <ul class="list">
      ${allShow.map(t=>{
        const pp = getPlantById(t.plantId);
        const isOver = t.dueMs < startOfToday;
        const badge = isOver ? `<span class="badge b-danger">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>` : `<span class="badge b-warn">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>`;
        return `
          <li class="item">
            <div class="top">
              <div>
                <div class="title">${escapeHtml(pp?.name||"‚Äî")} ‚Äî ${escapeHtml(t.title)}</div>
                <div class="meta">‡∏Å‡∏≥‡∏´‡∏ô‡∏î: <b>${escapeHtml(t.dueDate)} ${escapeHtml(t.dueTime)}</b><br/>${escapeHtml(t.detail||"")}</div>
              </div>
              ${badge}
            </div>
          </li>
        `;
      }).join("")}
    </ul>
  ` : `<div class="note">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÑ‡∏î‡πâ)</div>`;
}

function renderTaskEditDate(){
  const c = getActiveCycle();
  const tid = taskEditSelect.value;
  const t = (c.tasks || []).find(x=>x.id===tid);
  if(!t){ taskEditDate.value=""; return; }
  taskEditDate.value = toThaiDateTimeLocalInput(t.dueDate, t.dueTime);
}
taskEditSelect.addEventListener("change", renderTaskEditDate);

/* =========================
   TIMELINE RENDER (‡∏à‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß)
========================= */
function ensureTimelineSelect(){
  const c = getActiveCycle();
  const plantIdsInCycle = (c.plantsInCycle || []).map(x=>x.plantId);
  const unique = [...new Set(plantIdsInCycle)];

  timelinePlant.innerHTML = "";
  if(!unique.length){
    const o = document.createElement("option");
    o.value = "";
    o.textContent = "‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏±‡∏Å‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ ‚Äî";
    timelinePlant.appendChild(o);
    timelinePlant.disabled = true;
    return;
  }
  timelinePlant.disabled = false;

  unique.forEach(pid=>{
    const p = getPlantById(pid);
    const o = document.createElement("option");
    o.value = pid;
    o.textContent = p?.name || "‚Äî";
    timelinePlant.appendChild(o);
  });

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
  const cur = timelinePlant.dataset.selected || "";
  if(cur && unique.includes(cur)) timelinePlant.value = cur;
  else timelinePlant.value = unique[0];

  timelinePlant.dataset.selected = timelinePlant.value;
}
timelinePlant.addEventListener("change", ()=>{
  timelinePlant.dataset.selected = timelinePlant.value;
  renderTimeline();
});

function renderTimeline(){
  const c = getActiveCycle();
  ensureTimelineSelect();

  const pid = timelinePlant.value;
  if(!pid){
    timelinePct.textContent = "‚Äî";
    timelineEta.textContent = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å‡∏Å‡πà‡∏≠‡∏ô";
    timelineBar.style.width = "0%";
    timelineRange.textContent = "‚Äî";
    timelineList.innerHTML = `<div class="note">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå</div>`;
    return;
  }

  const thai = getThaiNow();
  const nowMs = parseDateTimeToMs(thai.date, thai.time);
  const startOfToday = parseDateTimeToMs(thai.date, "00:00:00");
  const endOfToday = parseDateTimeToMs(thai.date, "23:59:59");

  const tasks = (c.tasks || []).filter(t=>t.plantId===pid).slice().sort((a,b)=>a.dueMs-b.dueMs);
  if(!tasks.length){
    timelinePct.textContent = "‚Äî";
    timelineEta.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏±‡∏Å‡∏ô‡∏µ‡πâ";
    timelineBar.style.width = "0%";
    timelineRange.textContent = "‚Äî";
    timelineList.innerHTML = `<div class="note">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå</div>`;
    return;
  }

  const total = tasks.length;
  const doneCount = tasks.filter(t=>t.done).length;
  const pct = Math.round((doneCount/total)*100);
  timelinePct.textContent = `${pct}% (${doneCount}/${total})`;
  timelineBar.style.width = `${pct}%`;

  const first = tasks[0];
  const last = tasks[tasks.length-1];
  timelineRange.textContent = `${first.dueDate} ‚Üí ${last.dueDate}`;

  const lastMs = last.dueMs;
  const left = lastMs - nowMs;
  timelineEta.textContent = left>0 ? `‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏≠‡∏µ‡∏Å ${msToHuman(left)}` : `‡πÄ‡∏•‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß)`;

  const p = getPlantById(pid);

  timelineList.innerHTML = `
    <div class="note">‡∏ú‡∏±‡∏Å: <b>${escapeHtml(p?.name || "‚Äî")}</b> ‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤</div>
    <ul class="list">
      ${tasks.map(t=>{
        const isDone = !!t.done;
        const isToday = (!isDone && t.dueMs>=startOfToday && t.dueMs<=endOfToday);
        const isOver = (!isDone && t.dueMs<startOfToday);

        const cls = "item tl-item " + (isDone ? "done" : (isToday ? "today" : (isOver ? "overdue" : "")));
        const badge = isDone
          ? `<span class="badge b-ok">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>`
          : (isOver ? `<span class="badge b-danger">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>` : (isToday ? `<span class="badge b-warn">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>` : `<span class="badge b-info">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>`));

        return `
          <li class="${cls}">
            <div class="top">
              <div>
                <div class="title">${escapeHtml(t.title)}</div>
                <div class="meta">
                  ‡∏Å‡∏≥‡∏´‡∏ô‡∏î: <b>${escapeHtml(t.dueDate)} ${escapeHtml(t.dueTime)}</b><br/>
                  ${escapeHtml(t.detail || "")}
                </div>
              </div>
              ${badge}
            </div>
            <div class="actions">
              ${isDone ? "" : `<button class="smallbtn ok" onclick="markTaskDone('${t.id}')">‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>`}
              <button class="smallbtn" onclick="quickShiftTask('${t.id}', 1)">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô +1 ‡∏ß‡∏±‡∏ô</button>
              <button class="smallbtn" onclick="quickShiftTask('${t.id}', -1)">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô -1 ‡∏ß‡∏±‡∏ô</button>
            </div>
          </li>
        `;
      }).join("")}
    </ul>
  `;
}

function renderAll(){
  renderHeader();
  renderCycleSelect();
  renderPlantOptions();
  renderCalc();
  renderCyclePlants();
  renderTasks();
  renderTaskEditDate();
  renderToday();
  renderTimeline();
  renderHistory();
  renderPlantManage();
  applyTheme(db.settings.themeMode || "system");
}
renderAll();

/* =========================
   ACTIONS: cycles/plants/tasks
========================= */
btnSaveCycleNote.addEventListener("click", ()=>{
  const c = getActiveCycle();
  c.note = cycleNote.value.trim();
  saveDB();
  renderAll();
});

btnCreateCycle.addEventListener("click", ()=>{
  const name = (newCycleName.value || "").trim() || "‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà";
  const start = newCycleStart.value || getThaiNow().date;
  const germ = Number(newCycleGerm.value || 75);
  const target = Number(newCycleTargetHoles.value || 48);
  const thai = getThaiNow();

  const nc = {
    id: uid("cycle"),
    name,
    startDate: start,
    note: "",
    germDefault: Math.max(1, Math.min(100, germ)),
    targetHoles: Math.max(1, target),
    plantsInCycle: [],
    tasks: [],
    createdAt: formatThaiHuman(thai.date, thai.time)
  };
  db.cycles.unshift(nc);
  db.activeCycleId = nc.id;
  saveDB();
  newCycleName.value="";
  newCycleGerm.value="";
  renderAll();
});

btnAddPlantToCycle.addEventListener("click", ()=>{
  const c = getActiveCycle();
  const pid = plantSelect.value;
  const plant = getPlantById(pid);
  if(!plant) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å");

  const desired = Number(desiredHoles.value || c.targetHoles || 48);
  const germUsed = plantGerm.value ? Number(plantGerm.value) : (plant.defaultGerm || c.germDefault || 75);
  const r = calcSow(desired, germUsed);

  const sowDate = c.startDate;

  const already = c.plantsInCycle.find(x=>x.plantId===pid);
  if(already){
    if(!confirm("‡∏ú‡∏±‡∏Å‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏´‡∏°?")) return;
  }

  const pi = {
    id: uid("pi"),
    plantId: pid,
    desired: r.d,
    germUsed: r.g,
    sow: r.sow,
    extra: r.extra,
    sowDate
  };
  c.plantsInCycle.push(pi);

  generateTasksForPlant(c, pi);

  saveDB();
  renderAll();
});

function removePlantFromCycle(piId){
  const c = getActiveCycle();
  if(!confirm("‡∏•‡∏ö‡∏ú‡∏±‡∏Å‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å + ‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á?")) return;
  const pi = c.plantsInCycle.find(x=>x.id===piId);
  if(!pi) return;

  c.plantsInCycle = c.plantsInCycle.filter(x=>x.id!==piId);
  c.tasks = (c.tasks||[]).filter(t=>t.plantId!==pi.plantId);
  saveDB();
  renderAll();
}

function regenTasksForPlant(piId){
  const c = getActiveCycle();
  const pi = c.plantsInCycle.find(x=>x.id===piId);
  if(!pi) return;
  if(!confirm("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏à‡∏∞‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏±‡∏Å‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï) ?")) return;
  c.tasks = (c.tasks||[]).filter(t=>t.plantId!==pi.plantId);
  generateTasksForPlant(c, pi);
  saveDB();
  renderAll();
}

function generateTasksForPlant(cycle, plantInCycle){
  const pid = plantInCycle.plantId;
  const sowDate = plantInCycle.sowDate || cycle.startDate;
  TASK_TEMPLATE.forEach(tpl=>{
    const dueDate = daysAfter(sowDate, tpl.day);
    const dueTime = tpl.day===0 ? "08:00:00" : "08:30:00";
    const dueMs = parseDateTimeToMs(dueDate, dueTime);
    cycle.tasks.push({
      id: uid("task"),
      plantId: pid,
      title: tpl.title,
      detail: tpl.detail,
      type: tpl.type,
      dueDate, dueTime, dueMs,
      done:false
    });
  });
}

function markTaskDone(taskId){
  const c = getActiveCycle();
  const t = (c.tasks||[]).find(x=>x.id===taskId);
  if(!t) return;
  t.done = true;

  const thai = getThaiNow();
  db.logs.actions.push({
    id: uid("act"),
    cycleId: c.id,
    plantId: t.plantId,
    type: t.type || t.title,
    date: thai.date,
    time: thai.time,
    note: `‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏≤‡∏Å ‚Äú‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‚Äù: ${t.title}`
  });

  saveDB();
  renderAll();
}

function quickShiftTask(taskId, deltaDays){
  const c = getActiveCycle();
  const t = (c.tasks||[]).find(x=>x.id===taskId);
  if(!t) return;

  const baseMs = parseDateTimeToMs(t.dueDate, t.dueTime);
  const newMs = baseMs + deltaDays*24*60*60*1000;
  const dt = new Date(newMs);
  const newDate = dt.toLocaleDateString("sv-SE", { timeZone:"Asia/Bangkok" });
  const newTime = dt.toLocaleTimeString("th-TH", {
    timeZone:"Asia/Bangkok", hour:"2-digit", minute:"2-digit", second:"2-digit"
  });
  t.dueDate = newDate;
  t.dueTime = newTime;
  t.dueMs = parseDateTimeToMs(newDate, newTime);
  saveDB();
  renderAll();
}

/* =========================
   TODAY: mark next done + in-app alert
========================= */
btnMarkDone.addEventListener("click", ()=>{
  const c = getActiveCycle();
  const pending = (c.tasks||[]).filter(t=>!t.done).sort((a,b)=>a.dueMs-b.dueMs);
  const next = pending[0];
  if(!next) return;
  markTaskDone(next.id);
});

let lastAlertTaskId = null;
function inAppAlert(title, detail){
  try{
    if(db.settings.inAppAlert.vibrate && navigator.vibrate){
      navigator.vibrate([120,80,120]);
    }
    if(db.settings.inAppAlert.sound){
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine"; o.frequency.value = 880;
      g.gain.value = 0.05;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 180);
    }
  }catch(e){}
  alert(`${title}\n\n${detail||""}`);
}

function tick(){
  renderHeader();
  const c = getActiveCycle();
  const thai = getThaiNow();
  const nowMs = parseDateTimeToMs(thai.date, thai.time);

  const next = (c.tasks||[]).filter(t=>!t.done).sort((a,b)=>a.dueMs-b.dueMs)[0];
  if(next){
    const diff = next.dueMs - nowMs;
    if(db.settings.inAppAlert.enabled && diff<=0 && lastAlertTaskId !== next.id){
      lastAlertTaskId = next.id;
      const p = getPlantById(next.plantId);
      inAppAlert("‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚úÖ", `${p?.name || "‚Äî"}: ${next.title}\n‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${next.dueDate} ${next.dueTime}`);
    }
  }
  renderToday();
  renderTimeline();
}
setInterval(tick, 1000);

/* =========================
   LOGGING
========================= */
function setLogDefaults(){
  const thai = getThaiNow();
  healthDate.value = thai.date;
  actDate.value = thai.date;
  healthTime.value = thai.time;
  actTime.value = thai.time;
}
setLogDefaults();

btnSaveHealth.addEventListener("click", ()=>{
  const c = getActiveCycle();
  const pid = healthPlant.value;
  const date = healthDate.value || getThaiNow().date;
  const time = (healthTime.value || getThaiNow().time);
  const rec = {
    id: uid("health"),
    cycleId: c.id,
    plantId: pid,
    leafStatus: leafStatus.value,
    tempC: tempC.value ? Number(tempC.value) : null,
    date,
    time: time.length===5 ? (time+":00") : time,
    note: (healthNote.value||"").trim()
  };
  db.logs.health.push(rec);
  saveDB();
  healthNote.value="";
  tempC.value="";
  renderAll();
});

btnSaveAct.addEventListener("click", ()=>{
  const c = getActiveCycle();
  const pid = actPlant.value;
  const date = actDate.value || getThaiNow().date;
  const time = (actTime.value || getThaiNow().time);
  const rec = {
    id: uid("act"),
    cycleId: c.id,
    plantId: pid,
    type: actType.value,
    date,
    time: time.length===5 ? (time+":00") : time,
    note: (actNote.value||"").trim()
  };
  db.logs.actions.push(rec);

  if(actType.value==="‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î"){
    const pi = c.plantsInCycle.find(x=>x.plantId===pid);
    if(pi){
      if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ ‚Äú‡∏ß‡∏±‡∏ô‡πÄ‡∏û‡∏≤‡∏∞‚Äù ‡∏Ç‡∏≠‡∏á‡∏ú‡∏±‡∏Å‡∏ô‡∏µ‡πâ = ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏û‡∏≤‡∏∞‡πÑ‡∏´‡∏°?")){
        pi.sowDate = date;
        c.tasks = (c.tasks||[]).filter(t=>t.plantId!==pid);
        generateTasksForPlant(c, pi);
      }
    }
  }

  saveDB();
  actNote.value="";
  renderAll();
});

btnTaskSave.addEventListener("click", ()=>{
  const c = getActiveCycle();
  const tid = taskEditSelect.value;
  const t = (c.tasks||[]).find(x=>x.id===tid);
  if(!t) return;

  const val = taskEditDate.value;
  if(!val) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà");
  const [d, hm] = val.split("T");
  const dueDate = d;
  const dueTime = (hm.length===5 ? hm+":00" : hm);
  t.dueDate = dueDate;
  t.dueTime = dueTime;
  t.dueMs = parseDateTimeToMs(dueDate, dueTime);

  saveDB();
  renderAll();
});

btnTaskDone.addEventListener("click", ()=>{
  const c = getActiveCycle();
  const tid = taskEditSelect.value;
  if(!tid) return;
  markTaskDone(tid);
});

/* =========================
   PLANT MANAGE
========================= */
btnAddPlant.addEventListener("click", ()=>{
  const name = (newPlantName.value||"").trim();
  if(!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å");
  if(db.plants.some(p=>p.name.toLowerCase()===name.toLowerCase())){
    return alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
  }
  const g = newPlantGerm.value ? Number(newPlantGerm.value) : null;
  db.plants.push({
    id: uid("plant"),
    name,
    defaultGerm: g ? Math.max(1, Math.min(100, g)) : null
  });
  saveDB();
  newPlantName.value="";
  newPlantGerm.value="";
  renderAll();
});

function deletePlant(pid){
  if(!confirm("‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£? (‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)")) return;
  if(pid.startsWith("p_")) return alert("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
  db.plants = db.plants.filter(p=>p.id!==pid);
  saveDB();
  renderAll();
}

/* =========================
   EXPORT/IMPORT
========================= */
btnExport.addEventListener("click", ()=>{
  const data = JSON.stringify(db, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `farm_planner_backup_${getThaiNow().date}.json`;
  a.click();
  URL.revokeObjectURL(url);
});

btnImport.addEventListener("click", ()=> fileImport.click());
fileImport.addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const text = await f.text();
  try{
    const obj = JSON.parse(text);
    if(!obj || !obj.cycles) throw new Error("format");
    db = obj;

    // ‡∏Å‡∏±‡∏ô‡∏ï‡∏Å settings ‡πÉ‡∏´‡∏°‡πà
    db.settings = db.settings || {};
    db.settings.inAppAlert = db.settings.inAppAlert || { enabled:true, vibrate:true, sound:true };
    if(!db.settings.themeMode) db.settings.themeMode = "system";

    saveDB();
    applyTheme(db.settings.themeMode || "system");
    alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    renderAll();
  }catch(err){
    alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
  }finally{
    fileImport.value = "";
  }
});

/* =========================
   SETTINGS: test alert + how to pwa + reset
========================= */
btnTestInAppAlert.addEventListener("click", ()=>{
  inAppAlert("‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ", "‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏à‡∏∞‡∏™‡∏±‡πà‡∏ô/‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ");
});

btnHowToPWA.addEventListener("click", ()=>{
  alert(
`‡πÄ‡∏õ‡∏¥‡∏î Notification ‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏ô iPhone (‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏¢‡πà‡∏≠):
1) ‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏Æ‡∏™‡∏ï‡πå‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ô HTTPS (‡πÄ‡∏ä‡πà‡∏ô GitHub Pages, Netlify, Vercel)
2) ‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå: index.html + manifest.json + sw.js
3) ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö‡∏ú‡πà‡∏≤‡∏ô Safari
4) ‡∏Å‡∏î Share ‚Üí Add to Home Screen
5) ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Notification ‡πÑ‡∏î‡πâ

* ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (file://) ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á Notification ‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏ö`
  );
});

btnReset.addEventListener("click", ()=>{
  if(!confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°? (‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)")) return;
  localStorage.removeItem(LS_KEY);
  alert("‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤");
  location.reload();
});
</script>
</body>
</html>
